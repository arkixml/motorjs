<html>
  <head>
    <title>Motor simulator</title>
	<script type="text/javascript" src="sylvester.js"></script>
	<script type="text/javascript" src="jquery-2.1.0.min.js"></script>
    <script type="text/javascript">
	  var dt = 1/60;
	
	  var theta = 0;
	  var angVel = 0.5;
	  
	  var e_theta;
	  
	  var polePairs = 6;
	  
	  var center = $V([0,0]);
	  
	  var a_ref = $V([1,0]);
	  var b_ref = a_ref.rotate(Math.PI*2/3,center);
	  var c_ref = b_ref.rotate(Math.PI*2/3,center);
	  
	  var kt = 1;
	  var kv = 1;
	  var J = 1;
	  var drag = 0.1;
	  var Rs = 0.1;
	  
	  var a;
	  var b;
	  var c;
	  
	  var d;
	  var q;
	  
	  var id;
	  var iq;
	  
	  var vd;
	  var vq;
	  
	  function vectorDraw(ctx, v) {
	    ctx.beginPath();
	    ctx.moveTo(0,0);
		ctx.lineTo(v.elements[0]*100,v.elements[1]*100);
		ctx.closePath();
		ctx.stroke();
	  }
	  function updateMotor() {
	    var form = document.forms['motor'];
		polePairs = form.elements['polePairs'].value;
		var loadtorque = parseInt(form.elements['loadtorque'].value);
	    iq = parseInt(form.elements['iq'].value);
		var emf = angVel * kv;
		vq = emf + iq * Rs;
		
		var motor_t = iq * kt - angVel * drag;
		
		if (form.elements['loadtype'].value == 'speed') {
			loadtorque = motor_t;
			t = 0;
			angVel = parseInt(form.elements['angVel'].value);
		} else {
			t = motor_t - loadtorque;
			angVel += (dt * t / J);
		}
		
		var power = (iq * vq);
		var mechpower = angVel * loadtorque;
		
	    theta += angVel*dt;
		e_theta = (theta * polePairs);
		d = $V([1,0]).rotate(e_theta,center);
		q = $V([0,1]).rotate(e_theta,center);
		a = a_ref.x(d.dot(a_ref));
		b = b_ref.x(d.dot(b_ref));
		c = c_ref.x(d.dot(c_ref));
	
		$("#rpm").html((angVel * 9.5493).toFixed(2));
		$("#emf").html((emf).toFixed(2));
		$("#torque").html((iq * kt).toFixed(2));
		$("#power").html(power.toFixed(2));
		$("#mechpower").html(mechpower.toFixed(2));
		$("#efficiency").html((mechpower/power*100).toFixed(2));
		$("#vq").html(vq.toFixed(2));
		$("#resistanceloss").html((iq*iq*Rs).toFixed(2));
		$("#bearingloss").html((angVel*drag*angVel).toFixed(2));
		
		if (angVel > 200) {
			$("body").css("padding-left", Math.random()*angVel/100);
		}
	  }
	  function init() {
	    setInterval(draw,dt*1000);
      }
      function draw(){
        var canvas = document.getElementById('tutorial');
		updateMotor();
        if (canvas.getContext){
          var ctx = canvas.getContext('2d');
		  ctx.save();
		  ctx.clearRect(0,0,400,400);
		  ctx.scale(2,-2);
		  ctx.translate(100,-100);
		  
		  // coil vectors
		  ctx.save();
		  ctx.scale(0.25,0.25);
		  var outerRadius = 300;
		  for(var i = 0; i < polePairs; i++) {
			  //ctx.save();
			    ctx.translate(outerRadius,0);
			  	ctx.strokeStyle = "#7F7F7F";
				ctx.lineWidth = 1;
				vectorDraw(ctx, a_ref);
				vectorDraw(ctx, a_ref.x(-1));
				ctx.strokeStyle = "#000000";
				ctx.lineWidth = 4;
				vectorDraw(ctx, a);
				ctx.translate(-1*outerRadius,0);
			    ctx.rotate(Math.PI*2/3 / polePairs);
				ctx.translate(outerRadius,0);
				ctx.strokeStyle = "#7F7F7F";
				ctx.lineWidth = 1;
				vectorDraw(ctx, a_ref);
				vectorDraw(ctx, a_ref.x(-1));
				ctx.strokeStyle = "#000000";
				ctx.lineWidth = 4;
				vectorDraw(ctx, b.rotate(Math.PI*(-2/3),center));
				ctx.translate(-1*outerRadius,0);
			    ctx.rotate(Math.PI*2/3 / polePairs);
				ctx.translate(outerRadius,0);
				ctx.strokeStyle = "#7F7F7F";
				ctx.lineWidth = 1;
				vectorDraw(ctx, a_ref);
				vectorDraw(ctx, a_ref.x(-1));
				ctx.strokeStyle = "#000000";
				ctx.lineWidth = 4;
				vectorDraw(ctx, c.rotate(Math.PI*(-4/3),center));
				ctx.translate(-1*outerRadius,0);
			    ctx.rotate(Math.PI*2/3 / polePairs);
			  //ctx.restore();
		  }
		  ctx.restore();
		  ctx.rotate(theta-Math.PI/2);
		 
		  
		  // magnets
		  ctx.beginPath();
		  ctx.arc(0,0,25,0,Math.PI*2,true);
		  ctx.stroke();
		  ctx.closePath();
		  for (var i = 0; i < polePairs; i++) {
			ctx.fillStyle = "#FF0000";
			ctx.fillRect(-25 / polePairs,25,50 / polePairs,10);
			ctx.rotate(Math.PI / polePairs);
			ctx.fillStyle = "#0000FF";
			ctx.fillRect(-25 / polePairs,25,50 / polePairs,10);
			ctx.rotate(Math.PI / polePairs);
		  }
		  
		  // magnet vector
		  /*
		  ctx.beginPath();
		  ctx.moveTo(0,0);
		  ctx.lineTo(0,100);
		  ctx.closePath();
		  ctx.stroke();
		  ctx.beginPath();
		  ctx.moveTo(0,0);
		  ctx.lineTo(100,0);
		  ctx.stroke();
		  */
		  
		  ctx.restore();
        }
      }
    </script>
    <style type="text/css">
      canvas { border: 1px solid black; }
    </style>
  </head>
  <body onload="init();">
    <canvas id="tutorial" width="400" height="400"></canvas>
	<div>
	    <label>RPM: </label><span id="rpm"></span>
		<label>EMF: </label><span id="emf"></span>
		<label>Voltage: </label><span id="vq"></span>
		<label>Torque: </label><span id="torque"></span>
		<label>Electrical Power: </label><span id="power"></span>
		<label>Mechanical Power: </label><span id="mechpower"></span>
		<label>Resistance loss: </label><span id="resistanceloss"></span>
		<label>Bearing loss: </label><span id="bearingloss"></span>
		<label>Efficiency: </label><span id="efficiency"></span>
	</div>
	<form id="motor">
	  <h2>Motor settings:</h2>
	  <label>Pole pairs:</label><input type="range" name="polePairs" min="1" max="10" step="1" value="6">
	  <h2>Load settings:</h2>
	  <label>Load type:</label><select name="loadtype">
	  <option value="speed">Constant angular velocity</option>
	  <option value="torque">Constant torque</option>
	  </select>
	  <label>Angular velocity:</label><input type="range" name="angVel" min="0" max="5" value="0.5">
	  <label>Load torque:</label><input type="range" name="loadtorque" min="-100" max="100" value="0">
	  <h2>Inverter settings:</h2>
	  <label>Q-axis current:</label><input type="range" name="iq" min="-100" max="100" value="0">
	</form>
  </body>
</html>